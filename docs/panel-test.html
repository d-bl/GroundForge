<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="js/d3.v4.min.js" type="text/javascript"></script>
    <script src="js/GroundForge-opt.js" type="text/javascript"></script>
    <script src="js/nudgePairs.js" type="text/javascript"></script>
    <script src="js/panel.js" type="text/javascript"></script>
    <script src="js/stitch-gallery.js" type="text/javascript"></script>
    <title>Panel Test</title>
    <style>
        .gf_panel {display: inline-block; margin: 4px;}
        .gf_panel > div {width: 100%; overflow: auto; resize:both; border: #ddd solid 1px; }
        .gf_panel > figcaption {width: 100%; box-sizing: border-box; background-color: #ddd; }
        .gf_panel > figcaption img, .gf_panel > figcaption > input {margin-left: 0.5em;}
    </style>
</head>
<body>
<script>
    function generateSelectedDiagram(diagramType) {
        const checkedDroste = document.querySelector('input[name="droste"]:checked');
        const drosteIndex = parseInt(checkedDroste.value, 10);
        const stepValues = [];
        for (let i = 1; i <= drosteIndex; i++) {
            const textarea = document.getElementById('droste' + i);
            txt =  textarea && textarea.value.trim() ? textarea.value.trim() : "ct";
            stepValues.push(txt);
        }
        console.log(stepValues);
        GF_panel.diagramSVG({id: diagramType+ '_panel', query: q, type: diagramType, steps: stepValues});
    }
    function drosteControls(stepNr){
        return `
        <div style="display: flex; width: 100%;">
          <input type="radio" name="droste" value="${stepNr}" style="flex: 0 0 auto;">
          <textarea id="droste${stepNr}" style="flex: 1 1 0; width: 0; min-width: 0;" placeholder="droste step ${stepNr}, default all: ct"></textarea>
        </div>
      `;
    }
    q = "patchWidth=3&patchHeight=5&c1=tc&d1=tctc&e1=tc&c2=tctc&e2=tctc&d3=tc&shiftColsSE=2&shiftRowsSE=2&shiftColsSW=-2&shiftRowsSW=2&footside=-5,B-,-2,b-,,&tile=831,4-7,-5-&headside=5-,-c,6-,-c"
    GF_panel.load({caption: "options", id: "options", controls: ["resize"]}, document.body);
    document.getElementById('options').innerHTML = `<br>
        <div style="display: flex; width: 100%;">
          <input type="radio" name="droste" value="0" checked style="flex: 0 0 auto;">
          <input type="text" id="droste0" value="${q}" style="flex: 1 1 0; width: 0; min-width: 0;">
        </div>${drosteControls(1)}${drosteControls(2)}${drosteControls(3)}
        `;
    GF_panel.load({caption: "pair diagram", id: "pair_panel", wandHref: "javascript:generateSelectedDiagram('pair')", controls: ["resize"]}, document.body);
    GF_panel.load({caption: "thread diagram", id: "thread_panel", wandHref: "javascript:generateSelectedDiagram('thread')", controls: ["resize", "color"]}, document.body);
</script>
</body>
</html>